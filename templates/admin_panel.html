<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="/assets/css/reset.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <style>
        .sql-editor {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f8f8;
        }
        .sql-result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow: auto;
        }
        .sql-result table {
            width: 100%;
            border-collapse: collapse;
        }
        .sql-result th, .sql-result td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .sql-result th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
<main class="main-content">
    <div class="auth-card" style="max-width:1200px;">
        <h1>Админ-панель</h1>

        <!-- Пользователи -->
        <h2>Пользователи</h2>
        <table border="1" cellpadding="6" style="width:100%;margin-bottom:2em;">
            <tr>
                <th>ID</th>
                <th>Имя</th>
                <th>Ник</th>
                <th>Email</th>
                <th>Верификация</th>
                <th>Баланс</th>
                <th>Рейтинг</th>
                <th>Действия</th>
            </tr>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td><input type="text" form="user-edit-{{ user.id }}" name="name" value="{{ user.name }}" style="width:100px;"></td>
                <td><input type="text" form="user-edit-{{ user.id }}" name="nickname" value="{{ user.nickname }}" style="width:100px;"></td>
                <td><input type="text" form="user-edit-{{ user.id }}" name="email" value="{{ user.email }}" style="width:140px;"></td>
                <td>
                    {% if not user.admin_verified %}
                        <form method="post" action="/admin/user/{{ user.id }}/admin_verify" id="admin-verify-{{ user.id }}">
                            <input type="hidden" name="balance" value="{{ user.balance }}">
                            <input type="hidden" name="customer_rating" value="{{ user.customer_rating }}">
                            <button type="submit">Подтвердить</button>
                        </form>
                    {% else %}
                        Подтвержден
                    {% endif %}
                </td>
                <td><input type="number" form="user-edit-{{ user.id }}" name="balance" value="{{ user.balance }}" step="0.01" style="width:80px;"></td>
                <td><input type="number" form="user-edit-{{ user.id }}" name="customer_rating" value="{{ user.customer_rating }}" step="0.01" style="width:60px;"></td>
                <td>
                    <form method="post" action="/admin/user/{{ user.id }}/edit" id="user-edit-{{ user.id }}"></form>
                    <button type="submit" form="user-edit-{{ user.id }}">Сохранить</button>

                    <form method="post" action="/admin/user/{{ user.id }}/delete" style="display:inline;">
                        <button type="submit" onclick="return confirm('Удалить пользователя?')">Удалить</button>
                    </form>
                </td>
                <td>
                    <b>Заказы заказчика:</b>
                    {% for order in orders if order.customer_id == user.id %} #{{ order.id }} {% endfor %}<br>
                    <b>Заказы исполнителя:</b>
                    {% for order in orders if order.executor_id == user.id %}
                    <form method="post" action="/admin/order/{{ order.id }}/change_executor" style="display:inline;">
                        #{{ order.id }} <input type="number" name="executor_id" value="{{ order.executor_id }}" style="width:40px;">
                        <button type="submit">Изм.</button>
                    </form>
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Заказы -->
        <h2>Заказы</h2>
        <table border="1" cellpadding="6" style="width:100%;">
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
            {% for order in orders %}
            <tr>
                <td>{{ order.id }}</td>
                <td><input type="text" form="order-edit-{{ order.id }}" name="title" value="{{ order.name }}" style="width:120px;"></td>
                <td><input type="text" form="order-edit-{{ order.id }}" name="description" value="{{ order.description }}" style="width:220px;"></td>
                <td><input type="number" form="order-edit-{{ order.id }}" name="price" value="{{ order.price }}" style="width:80px;"></td>
                <td><input type="text" form="order-edit-{{ order.id }}" name="status" value="{{ order.status }}" style="width:80px;"></td>
                <td>
                    <form method="post" action="/admin/order/{{ order.id }}/edit" id="order-edit-{{ order.id }}"></form>
                    <button type="submit" form="order-edit-{{ order.id }}">Сохранить</button>

                    <form method="post" action="/admin/order/{{ order.id }}/delete" style="display:inline;">
                        <button type="submit" onclick="return confirm('Удалить заказ?')">Удалить</button>
                    </form>
                </td>
                <td>
                    <b>Исполнитель:</b> {{ order.executor_id if order.executor_id else '—' }}
                    {% if order.executor_id %}
                    <form method="post" action="/admin/order/{{ order.id }}/remove_executor" style="display:inline;">
                        <button type="submit" onclick="return confirm('Убрать исполнителя?')">Убрать</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Офферы -->
        <h2>Офферы</h2>
        <table border="1" cellpadding="6" style="width:100%;margin-bottom:2em;">
            <tr>
                <th>ID</th>
                <th>Текст</th>
                <th>Order ID</th>
                <th>Chat ID</th>
                <th>Sender ID</th>
                <th>Дата</th>
                <th>Действия</th>
            </tr>
            {% for offer in offers %}
            <tr>
                <td>{{ offer.id }}</td>
                <td><input type="text" form="offer-edit-{{ offer.id }}" name="text" value="{{ offer.text|e }}" style="width:220px;"></td>
                <td><input type="number" form="offer-edit-{{ offer.id }}" name="order_id" value="{{ offer.order_id }}" style="width:70px;"></td>
                <td>{{ offer.chat_id }}</td>
                <td>{{ offer.sender_id }}</td>
                <td>{{ offer.created_at }}</td>
                <td>
                    <form method="post" action="/admin/offer/{{ offer.id }}/edit" id="offer-edit-{{ offer.id }}"></form>
                    <button type="submit" form="offer-edit-{{ offer.id }}">Сохранить</button>

                    <form method="post" action="/admin/offer/{{ offer.id }}/delete" style="display:inline;">
                        <button type="submit" onclick="return confirm('Удалить оффер?')">Удалить</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- SQL Запросы -->
        <h2>SQL Запросы</h2>
        <div style="margin-bottom: 20px;">
            <textarea id="sql-query" class="sql-editor" placeholder="Введите SQL запрос..."></textarea>
            <button onclick="executeSql()" class="auth-button">Выполнить</button>
            <div id="sql-result" class="sql-result" style="display: none;">
                <h3>Результат:</h3>
                <div id="result-content"></div>
            </div>
        </div>

        <li><a href="/admin/commission">Настройки комиссий</a></li>
    </div>
</main>

<script>
    async function executeSql() {
        const query = document.getElementById('sql-query').value.trim();
        if (!query) {
            alert('Пожалуйста, введите SQL запрос');
            return;
        }

        try {
            const response = await fetch('/exec_sql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query }),
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                displayResult(data.result);
            } else {
                showError(data.detail || 'Ошибка выполнения запроса');
            }
        } catch (error) {
            showError('Ошибка сети: ' + error.message);
        }
    }

    function displayResult(result) {
        const container = document.getElementById('result-content');
        const resultDiv = document.getElementById('sql-result');

        if (!result || result.length === 0) {
            container.innerHTML = '<p>Запрос выполнен успешно. Результат отсутствует.</p>';
            resultDiv.style.display = 'block';
            return;
        }

        // Если результат - массив объектов
        if (Array.isArray(result) && result.length > 0 && typeof result[0] === 'object') {
            const keys = Object.keys(result[0]);

            let html = '<table><thead><tr>';
            keys.forEach(key => html += `<th>${key}</th>`);
            html += '</tr></thead><tbody>';

            result.forEach(row => {
                html += '<tr>';
                keys.forEach(key => html += `<td>${row[key] !== null ? row[key] : 'NULL'}</td>`);
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
        // Если результат - простые значения
        else {
            container.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        }

        resultDiv.style.display = 'block';
    }

    function showError(message) {
        const container = document.getElementById('result-content');
        const resultDiv = document.getElementById('sql-result');

        container.innerHTML = `<div style="color:red;">${message}</div>`;
        resultDiv.style.display = 'block';
    }
</script>
</body>
</html>