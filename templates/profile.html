<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç | TeenFreelance</title>
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Verdana:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .verify-phone-btn {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 0.4em 0.8em;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9em;
            margin-left: 0.8em;
            transition: background 0.2s;
        }
        .verify-phone-btn:hover {
            background: #3e8e41;
        }
    </style>
</head>
<body>
{% include 'header.html' %}
<main class="main-content auth-container">
    <div class="auth-card" style="max-width:700px;">
        <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <div style="margin-bottom:1.5em; text-align:right;">
            <a href="/favorites" class="apply-filters" style="padding:0.8em 2.2em;">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</a>
        </div>
        <div class="profile-section">
            {% if user.photo %}
            <div style="text-align:center; margin-bottom:1.2em;">
                <img src="/assets/images/{{ user.photo }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è"
                     style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
            </div>
            {% if user.phone_verified %}
            <span title="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω" class="verified-badge">üì±</span>
            {% endif %}

            {% if user.admin_verified %}
            <span title="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π" class="verified-badge admin">‚úÖ</span>
            {% endif %}
            {% endif %}
            <div class="form-group"><label>–ò–º—è:</label> <span>{{ user.name }}</span></div>
            <div class="form-group"><label>Email:</label> <span>{{ user.email }}</span></div>
            <div class="form-group"><label>–ù–∏–∫–Ω–µ–π–º:</label> <span>{{ user.nickname }}</span></div>
            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <span>
                    {% if user.phone_number %}
                        {{ user.phone_number }}
                        {% if not user.phone_verified %}
                            <a href="/verify_phone" class="verify-phone-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
                        {% else %}
                            <span title="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω">‚úì</span>
                        {% endif %}
                    {% else %}
                        –ù–µ —É–∫–∞–∑–∞–Ω
                        <a href="/profile/edit" class="verify-phone-btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</a>
                    {% endif %}
                </span>
            </div>
            <div class="form-group">
                <label>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</label>
                <span>
                    {% if user.admin_verified %}
                    <span title="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π">‚úÖ</span>
                    {% elif user.phone_verified %}
                    <span title="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω">‚úì</span>
                    {% else %}
                    –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
                    {% endif %}
                </span>
            </div>
            <div class="form-group"><label>–ë–∞–ª–∞–Ω—Å:</label> <span>{{ user.balance }} ‚ÇΩ</span></div>
            <div class="form-group"><label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label> <span>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            <div class="form-group"><label>–†–µ–π—Ç–∏–Ω–≥ –∑–∞–∫–∞–∑—á–∏–∫–∞:</label> <span>{{ user.customer_rating }}</span></div>
            <div class="form-group"><label>–†–µ–π—Ç–∏–Ω–≥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:</label> <span>{{ user.executor_rating }}</span></div>
            <div class="form-group"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:</label> <span>{{ user.done_count }}</span></div>
            <div class="form-group"><label>–í–∑—è—Ç–æ –∑–∞–∫–∞–∑–æ–≤:</label> <span>{{ user.taken_count }}</span></div>
            <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ:</label> <span>{{ user.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</span></div>
            <div style="display:flex; gap:1rem; margin-top:2rem;">
                <button class="auth-button" id="logout-btn">–í—ã–π—Ç–∏</button>
                <a href="/profile/edit" class="auth-button" style="background:#eee;color:#222;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    –ø—Ä–æ—Ñ–∏–ª—å</a>
            </div>
        </div>
        <hr style="margin:2rem 0;">
        <section class="user-orders">
            <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
            {% set current_orders = orders | selectattr('status', 'in', ['OPEN', 'WORK']) | list %}
            {% set closed_orders = orders | selectattr('status', 'equalto', 'CLOSE') | list %}
            <h3 style="margin-top:1em;">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h3>
            {% if current_orders %}
            <div class="orders-list" id="orders-list">
                {% for order in current_orders %}
                <div class="profile-order-block">
                    <div>
                        <b>{{ order.title }}</b> ‚Äî <p style="word-break: break-word;">{{ order.description }}</p><br>
                        –ë—é–¥–∂–µ—Ç: {{ order.price }} —Ä—É–±. | –°—Ç–∞—Ç—É—Å: {{ order.status }}
                    </div>
                    <div style="margin-top:0.7em;">
                        {% if order.status == 'OPEN' and order.can_close %}
                        <a href="#"
                           onclick="if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑?')){ fetch('/orders/{{ order.id }}/close', {method: 'POST', credentials: 'same-origin'}).then(()=>location.reload()); } return false;">–ó–∞–∫—Ä—ã—Ç—å
                            –∑–∞–∫–∞–∑</a>
                        {% endif %}
                        <a href="/orders/{{ order.id }}/edit"
                           style="font-weight:bold; margin-left:1.2em;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        {% if order.status == 'WORK' %}
                        <a href="/chat/{{ order.executor_id }}" style="font-weight:bold; margin-left:1.2em;">–ü–µ—Ä–µ–π—Ç–∏ –≤
                            —á–∞—Ç</a>
                        {% endif %}
                    </div>
                    <hr style="margin:1.2em 0;">
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>–ù–µ—Ç —Ç–µ–∫—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
            {% endif %}
            <h3 style="margin-top:2em;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∫–∞–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</h3>
            {% if active_exec %}
            <div class="orders-list" id="orders-list-exec">
                {% for order in active_exec %}
                <div class="profile-order-block">
                    <div>
                        <b>{{ order.title }}</b> ‚Äî <p style="word-break: break-word;">{{ order.description }}</p><br>
                        –ë—é–¥–∂–µ—Ç: {{ order.price }} —Ä—É–±. | –°—Ç–∞—Ç—É—Å: {{ order.status }}
                    </div>
                    <div style="margin-top:0.7em;">
                        {% if order.chat_id %}
                        <a href="/chat/{{ order.chat_id }}" style="font-weight:bold; margin-left:1.2em;">–ü–µ—Ä–µ–π—Ç–∏ –≤
                            —á–∞—Ç</a>
                        {% else %}
                        <span style="color:#c00;">–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</span>
                        {% endif %}
                    </div>
                    <hr style="margin:1.2em 0;">
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∫–∞–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å.</p>
            {% endif %}
            <h3 style="margin-top:2em;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
            {% if closed_orders %}
            <div class="orders-list" id="orders-list-history">
                {% for order in closed_orders %}
                <div class="profile-order-block">
                    <div>
                        <b>{{ order.title }}</b> ‚Äî <p style="word-break: break-word;">{{ order.description }}</p><br>
                        –ë—é–¥–∂–µ—Ç: {{ order.price }} —Ä—É–±. | –°—Ç–∞—Ç—É—Å: {{ order.status }}
                    </div>
                    <hr style="margin:1.2em 0;">
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
            {% endif %}
        </section>
        <div class="profile-extra">
            <h2>–ú–æ–∏ –æ—Ç–∑—ã–≤—ã</h2>
            {% if reviews and reviews|length > 0 %}
            <div class="reviews-list">
                {% for review in reviews %}
                <div class="review-block"
                     style="border:1px solid #eee; border-radius:8px; padding:1em; margin-bottom:1em;">
                    <div style="color:#c00;">ID: {{ review.id }}</div>
                    <b>–û—Ü–µ–Ω–∫–∞:</b> {{ review.rate }}<br>
                    <b>–¢–∏–ø:</b> {{ review.type }}<br>
                    <b>–¢–µ–∫—Å—Ç:</b> {{ review.text }}<br>
                    <b>–ó–∞–∫–∞–∑:</b> <a href="/orders/{{ review.order_id }}">#{{ review.order_id }}</a><br>
                    <span style="color:#888; font-size:0.95em;">{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    {% if review.response %}
                    <div style="margin-top:0.7em; padding:0.7em; background:#f6fff6; border-radius:6px; border:1px solid #b3e6b3;">
                        <b>–û—Ç–≤–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è:</b> {{ review.response }}
                    </div>
                    {% else %}
                    <form class="review-response-form" data-review-id="{{ review.id }}" style="margin-top:0.7em;">
                        <textarea name="response" required minlength="2" maxlength="100"
                                  style="width:100%;min-height:40px;"></textarea><br>
                        <button type="submit" class="apply-filters">–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Ç–∑—ã–≤</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div>–ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∞—à–∏ –æ—Ç–∑—ã–≤—ã...</div>
            {% endif %}
        </div>
    </div>
</main>
{% include 'footer.html' %}
<script src="assets/js/main.js"></script>
<script>
    document.getElementById('logout-btn').onclick = async function() {
        await fetch('/api/logout', {method:'POST'});
        window.location.href = '/login';
    };
</script>
<script>
    async function closeOrder(event, orderId) {
        event.preventDefault();
        const res = await fetch(`/orders/${orderId}/close`, {method: 'POST', credentials: 'same-origin'});
        const data = await res.json();
        if (data.success) {
            // –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ DOM –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            const el = document.getElementById('order-' + orderId);
            if (el) el.remove();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–∫–∞–∑–∞');
        }
        return false;
    }
</script>
<script>
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('review-response-form')) {
            e.preventDefault();
            const form = e.target;
            const reviewId = form.dataset.reviewId;
            const formData = new FormData(form);
            fetch(`/reviews/${reviewId}/response`, {method:'POST', body:formData, credentials:'same-origin'})
                .then(resp => { if (resp.ok) location.reload(); else alert('–û—à–∏–±–∫–∞!'); });
        }
    });
</script>
</body>
</html> 