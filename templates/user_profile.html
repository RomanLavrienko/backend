<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | TeenFreelance</title>
    <link rel="stylesheet" href="/assets/css/reset.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Verdana:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
{% include 'header.html' %}
<main class="main-content">
    <div class="profile-container"
         style="max-width:700px;margin:2.5rem auto;background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.10);padding:2.5rem 2rem;">
        <div style="display:flex;gap:2.5rem;align-items:flex-start;flex-wrap:wrap;">
            <div style="flex:1 1 220px;min-width:200px;max-width:320px;">
                <div class="profile-avatar"
                     style="width:90px;height:90px;border-radius:50%;background:#e0e0e0;margin-bottom:1.2em;">
                    {% if user.photo %}
                    <img src="/assets/images/{{ user.photo }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è"
                         style="width:90px;height:90px;border-radius:50%;object-fit:cover;">
                    {% endif %}
                    {% if user.phone_verified %}
                    <span title="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω" class="verified-badge">üì±</span>
                    {% endif %}

                    {% if user.admin_verified %}
                    <span title="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π" class="verified-badge admin">‚úÖ</span>
                    {% endif %}
                </div>
                <h2 style="font-size:2rem;font-weight:700;margin-bottom:0.2em;">{{ user.name }}{% if user.is_support %}
                    <span title="–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏" style="color:#1ed760;">‚úî</span>{% endif %}</h2>
                <div style="color:#1ed760;font-weight:500;margin-bottom:0.5em;">@{{ user.nickname }}</div>
                <div style="color:#888;font-size:1.1em;margin-bottom:1.2em;">–ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —Å {{
                    user.created_at.strftime('%d.%m.%Y') if user.created_at else '' }}
                </div>
                <div style="margin-bottom:1.2em;">
                    <span style="font-weight:500;">–†–µ–π—Ç–∏–Ω–≥ –∑–∞–∫–∞–∑—á–∏–∫–∞:</span> {{ customer_rating }}<br>
                    <span style="font-weight:500;">–†–µ–π—Ç–∏–Ω–≥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:</span> {{ executor_rating }}<br>
                    <span style="font-weight:500;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:</span> {{ user.done_count or 0 }}<br>
                    <span style="font-weight:500;">–í–∑—è—Ç–æ –∑–∞–∫–∞–∑–æ–≤:</span> {{ user.taken_count or 0 }}
                </div>
            </div>
            <div style="flex:2 1 320px;min-width:260px;">
                <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:0.7em;">–û —Å–µ–±–µ</h3>
                {% if user.description %}
                <div style="font-size:1.1em;line-height:1.6;white-space:pre-line;">{{ user.description }}</div>
                {% endif %}
                <div style="margin-top:2em;">
                    <h3 style="font-size:1.1em;font-weight:700;margin-bottom:0.7em;">–ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    {% if orders and orders|length > 0 %}
                    <ul style="padding-left:0;list-style:none;">
                        {% for order in orders if order.status == 'OPEN' %}
                        <li style="margin-bottom:1.2em;">
                            <a href="/orders/{{ order.id }}" style="font-weight:600;font-size:1.1em;">{{ order.name
                                }}</a><br>
                            <span style="color:#888;">{{ order.description }}</span><br>
                            <span style="color:#1ed760;">{{ order.price }} ‚ÇΩ</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div style="color:#888;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="profile-extra" style="margin-top:2.5em;">
        <h3 style="font-size:1.1em;font-weight:700;margin-bottom:0.7em;">–û—Ç–∑—ã–≤—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
        {% if reviews and reviews|length > 0 %}
        <div class="reviews-list">
            {% for review in reviews %}
            <div class="review-block" style="border:1px solid #eee; border-radius:8px; padding:1em; margin-bottom:1em;">
                <b>–û—Ü–µ–Ω–∫–∞:</b> {{ review.rate }}<br>
                <b>–¢–∏–ø:</b> {{ review.type }}<br>
                <b>–¢–µ–∫—Å—Ç:</b> {{ review.text }}<br>
                <b>–ó–∞–∫–∞–∑:</b> <a href="/orders/{{ review.order_id }}">#{{ review.order_id }}</a><br>
                <span style="color:#888; font-size:0.95em;">{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                {% if current_user_id and review.sender_id == current_user_id %}
                <button class="edit-review-btn" data-review-id="{{ review.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                {% endif %}
                {% if review.response %}
                <div style="margin-top:0.7em; padding:0.7em; background:#f6fff6; border-radius:6px; border:1px solid #b3e6b3;">
                    <b>–û—Ç–≤–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è:</b> {{ review.response }}
                </div>
                {% elif current_user_id and user.id == current_user_id %}
                <form class="review-response-form" data-review-id="{{ review.id }}" style="margin-top:0.7em;">
                    <textarea name="response" required minlength="2" maxlength="100"
                              style="width:100%;min-height:40px;"></textarea><br>
                    <button type="submit" class="apply-filters">–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Ç–∑—ã–≤</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="color:#888;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</div>
        {% endif %}
    </div>
</main>
{% include 'footer.html' %}
<script src="/assets/js/main.js"></script>
<script>
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
    document.querySelectorAll('.edit-review-btn').forEach(btn => {
        btn.onclick = function() {
            const reviewId = btn.dataset.reviewId;
            const block = btn.closest('.review-block');
            const text = block.querySelector('b:nth-of-type(3)').nextSibling.textContent.trim();
            const rate = block.querySelector('b:nth-of-type(1)').nextSibling.textContent.trim();
            const formHtml = `<form class='edit-review-form' data-review-id='${reviewId}' style='margin-top:0.7em;'>
                <label>–û—Ü–µ–Ω–∫–∞: <select name='rate'>
                    <option value='5' ${rate==5?'selected':''}>5</option>
                    <option value='4' ${rate==4?'selected':''}>4</option>
                    <option value='3' ${rate==3?'selected':''}>3</option>
                    <option value='2' ${rate==2?'selected':''}>2</option>
                    <option value='1' ${rate==1?'selected':''}>1</option>
                </select></label><br>
                <label>–¢–µ–∫—Å—Ç:<br><textarea name='text' required minlength='3' maxlength='150' style='width:100%;min-height:40px;'>${text}</textarea></label><br>
                <button type='submit' class='apply-filters'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>`;
            btn.style.display = 'none';
            block.insertAdjacentHTML('beforeend', formHtml);
            block.querySelector('.edit-review-form').onsubmit = async function(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const resp = await fetch(`/reviews/${reviewId}/edit`, {method:'POST', body:formData, credentials:'same-origin'});
                if (resp.ok) location.reload(); else alert('–û—à–∏–±–∫–∞!');
            };
        };
    });
    // –û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤
    document.querySelectorAll('.review-response-form').forEach(form => {
        form.onsubmit = async function(e) {
            e.preventDefault();
            const reviewId = form.dataset.reviewId;
            const formData = new FormData(form);
            const resp = await fetch(`/reviews/${reviewId}/response`, {method:'POST', body:formData, credentials:'same-origin'});
            if (resp.ok) location.reload(); else alert('–û—à–∏–±–∫–∞!');
        };
    });
</script>
</body>
</html> 